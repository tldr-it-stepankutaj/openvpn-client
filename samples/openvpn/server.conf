# OpenVPN Server Configuration (UDP)
# Integrated with OpenVPN Manager API
# UDP on port 1194 (standard OpenVPN port) - recommended for best performance

### NETWORK ###
mode server
tls-server
local 0.0.0.0
port 1194
proto udp
dev tun
topology subnet

# VPN subnet
server 10.90.90.0 255.255.255.0
push "topology subnet"

### CERTIFICATES ###
ca /etc/openvpn/pki/ca.crt
cert /etc/openvpn/pki/server.crt
key /etc/openvpn/pki/server.key
dh /etc/openvpn/pki/dh.pem
crl-verify /etc/openvpn/pki/crl.pem
tls-auth /etc/openvpn/pki/ta.key 0

### ENCRYPTION ###
cipher AES-256-GCM
data-ciphers AES-256-GCM:AES-128-GCM:CHACHA20-POLY1305
auth SHA256

### CONNECTION ###
keepalive 10 120

### PRIVILEGES ###
user openvpn
group openvpn
persist-key
persist-tun

### LOGGING ###
status /var/log/openvpn/status.log
log-append /var/log/openvpn/openvpn.log
verb 3

### MANAGEMENT ###
management localhost 7505

### OPENVPN MANAGER INTEGRATION ###
# Use username as common name (required for API integration)
username-as-common-name

# Authentication script - validates credentials against API
auth-user-pass-verify /usr/local/bin/openvpn-login via-file

# Client connect - assigns IP, pushes routes from user's groups
# Also handles redirect-gateway if user has 0.0.0.0/0 network assigned
client-connect /usr/local/bin/openvpn-connect

# Client disconnect - records session end and traffic stats
client-disconnect /usr/local/bin/openvpn-disconnect

# Enable script execution
script-security 2

# Disable renegotiation (prevents script re-execution during session)
reneg-sec 0

### NOTES ###
# - CCD (client-config-dir) is NOT needed - openvpn-connect handles IP/routes dynamically
# - To route all traffic through VPN, add network 0.0.0.0/0 to user's group in OpenVPN Manager
# - Static IPs are assigned from user's vpn_ip field in OpenVPN Manager
